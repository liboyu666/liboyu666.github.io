<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="é±¼å­ç»˜å›¾ Pro - Advanced AI Art Creation Tool">
    <meta name="author" content="liboyu666">
    <meta name="updated-date" content="2025-03-17">
    <meta name="version" content="2.0.0">
    
    <title>é±¼å­ç»˜å›¾ Pro - Advanced AI Art Creation | Contact: 2116498608@qq.com</title>
    
    <!-- å¤–éƒ¨ä¾èµ– -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- å…¨å±€é…ç½®å¯¹è±¡ -->
    <script>
        window.APP_CONFIG = {
            version: '2.0.0',
            buildDate: '2025-03-17',
            lastUpdated: '2025-03-17 09:38:13',
            author: 'liboyu666',
            contact: '2116498608@qq.com',
            
            // APIç«¯ç‚¹
            endpoints: {
                primary: 'https://api.prodia.com/v1',
                backup: 'https://image.pollinations.ai/prompt',
                civitai: 'https://civitai.com/api/v1',
                lexica: 'https://lexica.art/api/v1'
            },

            // é»˜è®¤å‚æ•°
            defaults: {
                width: 512,
                height: 512,
                steps: 30,
                cfg_scale: 7,
                sampler: 'euler_a',
                negative_prompt: 'lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, normal quality, jpeg artifacts, signature, watermark, username, blurry'
            },

            // é¢„è®¾é…ç½®
            presets: {
                highQuality: {
                    steps: 50,
                    cfg_scale: 7,
                    sampler: 'dpm++',
                    width: 1024,
                    height: 1024,
                    model: 'sdxl'
                },
                fast: {
                    steps: 20,
                    cfg_scale: 7,
                    sampler: 'euler_a',
                    width: 512,
                    height: 512,
                    model: 'sd15'
                },
                artistic: {
                    steps: 40,
                    cfg_scale: 8,
                    sampler: 'dpm_sde',
                    width: 768,
                    height: 768,
                    model: 'anything5'
                }
            },

            // å¯ç”¨æ¨¡å‹åˆ—è¡¨
            models: [
                { id: 'sdxl', name: 'Stable Diffusion XL', type: 'general' },
                { id: 'sd15', name: 'Stable Diffusion 1.5', type: 'general' },
                { id: 'anything5', name: 'Anything V5', type: 'anime' },
                { id: 'realistic', name: 'Realistic Vision V4', type: 'realistic' },
                { id: 'anime', name: 'Animagine XL', type: 'anime' }
            ],

            // VAEæ¨¡å‹åˆ—è¡¨
            vae: [
                { id: 'default', name: 'é»˜è®¤ VAE' },
                { id: 'kl-f8-anime2', name: 'KL F8 Anime 2' },
                { id: 'vae-ft-mse-840000', name: 'VAE FT MSE 840000' }
            ],

            // é‡‡æ ·å™¨åˆ—è¡¨
            samplers: [
                { id: 'euler_a', name: 'Euler a' },
                { id: 'dpm++', name: 'DPM++ 2M Karras' },
                { id: 'dpm_sde', name: 'DPM++ SDE Karras' },
                { id: 'ddim', name: 'DDIM' },
                { id: 'unipc', name: 'UniPC' }
            ]
        };
    </script>

    <!-- å…¨å±€æ ·å¼ -->
    <style>
        /* æ ¹å˜é‡å’Œä¸»é¢˜é…ç½® */
        :root {
            --primary-color: #94A684;    /* å¥¶æ²¹ç»¿ */
            --secondary-color: #E4E4D0;  /* æ·¡å¥¶æ²¹ */
            --accent-color: #AEC3AE;     /* æŸ”å’Œç»¿ */
            --background-color: #F5F5F5; /* çº¯å‡€ç™½ */
            --text-color: #4A4A4A;       /* æ¸©å’Œé»‘ */
            --error-color: #FF6B6B;      /* é”™è¯¯çº¢ */
            --success-color: #51CF66;    /* æˆåŠŸç»¿ */
            --warning-color: #FFD43B;    /* è­¦å‘Šé»„ */
            --info-color: #339AF0;       /* ä¿¡æ¯è“ */
            
            /* å°ºå¯¸å˜é‡ */
            --border-radius-sm: 4px;
            --border-radius: 8px;
            --border-radius-lg: 12px;
            --spacing-unit: 8px;
            --header-height: 60px;
            --sidebar-width: 300px;
            --footer-height: 40px;
            
            /* é˜´å½±æ•ˆæœ */
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow: 0 4px 6px rgba(0,0,0,0.07);
            --shadow-lg: 0 8px 16px rgba(0,0,0,0.1);
            
            /* åŠ¨ç”»æ—¶é—´ */
            --transition-fast: 0.15s;
            --transition-normal: 0.25s;
            --transition-slow: 0.35s;
        }

        /* æ·±è‰²ä¸»é¢˜ */
        [data-theme="dark"] {
            --primary-color: #BB86FC;
            --secondary-color: #1F1B24;
            --accent-color: #03DAC6;
            --background-color: #121212;
            --text-color: #FFFFFF;
        }

        /* åŸºç¡€æ ·å¼é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
            transition: background-color var(--transition-normal);
        }

        /* å¸ƒå±€ç»„ä»¶ */
        .app-container {
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            grid-template-rows: var(--header-height) 1fr var(--footer-height);
            min-height: 100vh;
        }

        .sidebar {
            grid-column: 1;
            grid-row: 1 / -1;
            background: white;
            border-right: 1px solid var(--secondary-color);
            padding: var(--spacing-unit);
            overflow-y: auto;
            z-index: 10;
        }

        .main-content {
            grid-column: 2;
            grid-row: 2;
            padding: calc(var(--spacing-unit) * 2);
            overflow-y: auto;
        }

        /* ç»„ä»¶æ ·å¼ */
        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: calc(var(--spacing-unit) / 2);
            padding: calc(var(--spacing-unit) * 1.5) calc(var(--spacing-unit) * 2);
            border-radius: var(--border-radius);
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            user-select: none;
        }

        .button-primary {
            background: var(--primary-color);
            color: white;
        }

        .button-primary:hover {
            background: var(--accent-color);
            transform: translateY(-1px);
        }

        /* è¡¨å•æ§ä»¶ */
        .input-group {
            margin-bottom: var(--spacing-unit);
        }

        .input-label {
            display: block;
            margin-bottom: calc(var(--spacing-unit) / 2);
            font-weight: 500;
        }

        .input-field {
            width: 100%;
            padding: calc(var(--spacing-unit) * 1.5);
            border: 1px solid var(--secondary-color);
            border-radius: var(--border-radius);
            transition: border-color var(--transition-fast);
        }

        .input-field:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        /* æç¤ºå’Œé€šçŸ¥ */
        .toast-container {
            position: fixed;
            top: calc(var(--spacing-unit) * 2);
            right: calc(var(--spacing-unit) * 2);
            z-index: 1000;
        }

        .toast {
            padding: calc(var(--spacing-unit) * 2);
            margin-bottom: var(--spacing-unit);
            border-radius: var(--border-radius);
            background: white;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: var(--spacing-unit);
            animation: slideIn var(--transition-normal);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--secondary-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* å“åº”å¼å¸ƒå±€ */
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 100%;
            }

            .app-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                grid-column: 1;
                grid-row: 1;
                border-right: none;
                border-bottom: 1px solid var(--secondary-color);
            }

            .main-content {
                grid-column: 1;
                grid-row: 2;
            }
        }

        /* è¾…åŠ©ç±» */
        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .flex-center {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .grid {
            display: grid;
        }

        .gap-1 {
            gap: var(--spacing-unit);
        }

        .gap-2 {
            gap: calc(var(--spacing-unit) * 2);
        }

        .m-1 {
            margin: var(--spacing-unit);
        }

        .m-2 {
            margin: calc(var(--spacing-unit) * 2);
        }

        .p-1 {
            padding: var(--spacing-unit);
        }

        .p-2 {
            padding: calc(var(--spacing-unit) * 2);
        }
    </style>
</head>
<body>
    <!-- åŠ è½½é®ç½© -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <div id="loading-text">æ­£åœ¨åŠ è½½...</div>
    </div>

    <!-- é€šçŸ¥å®¹å™¨ -->
    <div id="toast-container" class="toast-container"></div>

    <div class="app-container">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3 class="logo">ğŸ¨ é±¼å­ç»˜å›¾ Pro</h3>
                <div class="user-info">
                    <span class="username">@liboyu666</span>
                    <span class="version">v2.0.0</span>
                </div>
            </div>

            <!-- æ¨¡å‹é€‰æ‹© -->
            <div class="card p-2 m-2">
                <h5>æ¨¡å‹é€‰æ‹©</h5>
                <div class="input-group">
                    <label class="input-label">åŸºç¡€æ¨¡å‹</label>
                    <select id="base-model" class="input-field">
                        <option value="sdxl">Stable Diffusion XL</option>
                        <option value="sd15">Stable Diffusion 1.5</option>
                        <option value="anything5">Anything V5</option>
                        <option value="realistic">Realistic Vision V4</option>
                        <option value="anime">Animagine XL</option>
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label">VAEæ¨¡å‹</label>
                    <select id="vae-model" class="input-field">
                        <option value="default">é»˜è®¤ VAE</option>
                        <option value="kl-f8-anime2">KL F8 Anime 2</option>
                        <option value="vae-ft-mse-840000">VAE FT MSE 840000</option>
                    </select>
                </div>
            </div>

            <!-- å¿«é€Ÿé¢„è®¾ -->
            <div class="card p-2 m-2">
                <h5>å¿«é€Ÿé¢„è®¾</h5>
                <div class="grid gap-1">
                    <button class="button button-primary" onclick="applyPreset('highQuality')">
                        <i class="bi bi-stars"></i> é«˜è´¨é‡
                    </button>
                    <button class="button button-secondary" onclick="applyPreset('fast')">
                        <i class="bi bi-lightning"></i> å¿«é€Ÿç”Ÿæˆ
                    </button>
                    <button class="button button-accent" onclick="applyPreset('artistic')">
                        <i class="bi bi-palette"></i> è‰ºæœ¯é£æ ¼
                    </button>
                </div>
            </div>

            <!-- ç”Ÿæˆå†å² -->
            <div class="card p-2 m-2">
                <h5>ç”Ÿæˆå†å²</h5>
                <div id="history-container" class="history-grid"></div>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <!-- æ ‡ç­¾å¯¼èˆª -->
            <nav class="tab-nav">
                <button class="tab-button active" data-tab="txt2img">
                    <i class="bi bi-text-paragraph"></i> æ–‡ç”Ÿå›¾
                </button>
                <button class="tab-button" data-tab="img2img">
                    <i class="bi bi-image"></i> å›¾ç”Ÿå›¾
                </button>
                <button class="tab-button" data-tab="inpaint">
                    <i class="bi bi-brush"></i> å±€éƒ¨é‡ç»˜
                </button>
                <button class="tab-button" data-tab="extras">
                    <i class="bi bi-magic"></i> åæœŸå¤„ç†
                </button>
                <button class="tab-button" data-tab="settings">
                    <i class="bi bi-gear"></i> è®¾ç½®
                </button>
            </nav>

            <!-- æ ‡ç­¾å†…å®¹ -->
            <div class="tab-content">
                <!-- æ–‡ç”Ÿå›¾é¢æ¿ -->
                <div id="txt2img-panel" class="tab-panel active">
                    <div class="card p-2">
                        <div class="input-group">
                            <label class="input-label">æ­£å‘æç¤ºè¯</label>
                            <textarea id="positive-prompt" class="input-field" rows="3"
                                placeholder="masterpiece, best quality, ultra-detailed..."></textarea>
                        </div>
                        <div class="input-group">
                            <label class="input-label">åå‘æç¤ºè¯</label>
                            <textarea id="negative-prompt" class="input-field" rows="2"
                                placeholder="lowres, bad anatomy, text, watermark..."></textarea>
                        </div>
                        
                        <div class="parameter-grid">
                            <div class="input-group">
                                <label class="input-label">é‡‡æ ·å™¨</label>
                                <select id="sampler" class="input-field">
                                    <option value="euler_a">Euler a</option>
                                    <option value="dpm++">DPM++ 2M Karras</option>
                                    <option value="dpm_sde">DPM++ SDE Karras</option>
                                    <option value="ddim">DDIM</option>
                                    <option value="unipc">UniPC</option>
                                </select>
                            </div>
                            
                            <div class="input-group">
                                <label class="input-label">é‡‡æ ·æ­¥æ•°: <span id="steps-value">30</span></label>
                                <input type="range" id="steps" class="range-slider" 
                                    min="1" max="150" value="30">
                            </div>
                            
                            <div class="input-group">
                                <label class="input-label">CFG Scale: <span id="cfg-value">7</span></label>
                                <input type="range" id="cfg" class="range-slider" 
                                    min="1" max="30" step="0.5" value="7">
                            </div>
                            
                            <div class="input-group">
                                <label class="input-label">éšæœºç§å­</label>
                                <div class="input-with-button">
                                    <input type="number" id="seed" class="input-field" value="-1">
                                    <button class="button" onclick="randomizeSeed()">
                                        <i class="bi bi-shuffle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="size-controls">
                            <div class="input-group">
                                <label class="input-label">å›¾ç‰‡å°ºå¯¸</label>
                                <div class="flex gap-1">
                                    <select id="width" class="input-field">
                                        <option value="512">512px</option>
                                        <option value="768">768px</option>
                                        <option value="1024">1024px</option>
                                    </select>
                                    <select id="height" class="input-field">
                                        <option value="512">512px</option>
                                        <option value="768">768px</option>
                                        <option value="1024">1024px</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <label class="input-label">æ‰¹é‡ç”Ÿæˆ</label>
                                <select id="batch-count" class="input-field">
                                    <option value="1">1å¼ </option>
                                    <option value="2">2å¼ </option>
                                    <option value="4">4å¼ </option>
                                </select>
                            </div>
                        </div>

                        <button id="generate-button" class="button button-primary" onclick="startGeneration()">
                            <i class="bi bi-magic"></i> å¼€å§‹ç”Ÿæˆ
                        </button>
                    </div>

                    <!-- é¢„è§ˆåŒºåŸŸ -->
                    <div id="preview-container" class="card p-2 m-2">
                        <div class="preview-header">
                            <h5>ç”Ÿæˆç»“æœ</h5>
                            <div class="preview-controls">
                                <button class="button" onclick="downloadAll()">
                                    <i class="bi bi-download"></i> å…¨éƒ¨ä¸‹è½½
                                </button>
                            </div>
                        </div>
                        <div id="results-grid" class="results-grid"></div>
                    </div>
                </div>

                <!-- å…¶ä»–é¢æ¿ -->
                <div id="img2img-panel" class="tab-panel hidden">
                    <!-- å›¾ç”Ÿå›¾é¢æ¿å†…å®¹ -->
                </div>

                <div id="inpaint-panel" class="tab-panel hidden">
                    <!-- å±€éƒ¨é‡ç»˜é¢æ¿å†…å®¹ -->
                </div>

                <div id="extras-panel" class="tab-panel hidden">
                    <!-- åæœŸå¤„ç†é¢æ¿å†…å®¹ -->
                </div>

                <div id="settings-panel" class="tab-panel hidden">
                    <!-- è®¾ç½®é¢æ¿å†…å®¹ -->
                </div>
            </div>
        </main>
    </div>
    <!-- æ ¸å¿ƒJavaScriptå®ç° -->
    <script>
        // å…¨å±€çŠ¶æ€ç®¡ç†
        const AppState = {
            currentTab: 'txt2img',
            isGenerating: false,
            lastGeneratedImages: [],
            history: [],
            settings: {},
            
            init() {
                this.loadSettings();
                this.loadHistory();
                PerformanceMonitor.instance.startMonitoring();
            },

            loadSettings() {
                try {
                    this.settings = JSON.parse(localStorage.getItem('app_settings')) || {};
                } catch (e) {
                    console.error('Failed to load settings:', e);
                    this.settings = {};
                }
            },

            loadHistory() {
                try {
                    this.history = JSON.parse(localStorage.getItem('generation_history')) || [];
                } catch (e) {
                    console.error('Failed to load history:', e);
                    this.history = [];
                }
            },

            saveSettings() {
                localStorage.setItem('app_settings', JSON.stringify(this.settings));
            },

            saveHistory() {
                localStorage.setItem('generation_history', JSON.stringify(this.history));
            }
        };

        // å·¥å…·ç±»
        const Utils = {
            async delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            },

            randomInt(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            },

            formatDate(date) {
                return new Date(date).toISOString().slice(0, 19).replace('T', ' ');
            },

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.innerHTML = `
                    <i class="bi bi-${this.getToastIcon(type)}"></i>
                    <span>${message}</span>
                `;
                document.getElementById('toast-container').appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            },

            getToastIcon(type) {
                const icons = {
                    info: 'info-circle',
                    success: 'check-circle',
                    error: 'x-circle',
                    warning: 'exclamation-circle'
                };
                return icons[type] || icons.info;
            },

            async copyToClipboard(text) {
                try {
                    await navigator.clipboard.writeText(text);
                    this.showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                } catch (e) {
                    this.showToast('å¤åˆ¶å¤±è´¥', 'error');
                }
            },

            downloadImage(url, filename) {
                const a = document.createElement('a');
                a.href = url;
                a.download = filename || `generated-${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            },

            sanitizePrompt(prompt) {
                return prompt.trim()
                    .replace(/[\n\r]+/g, ' ')
                    .replace(/\s+/g, ' ');
            },

            validateGenerationParams(params) {
                const required = ['prompt', 'width', 'height', 'steps', 'cfg_scale'];
                for (const param of required) {
                    if (!params[param]) {
                        throw new Error(`Missing required parameter: ${param}`);
                    }
                }
                return true;
            },

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        };

        // å›¾åƒç”Ÿæˆå™¨ç±»
        class ImageGenerator {
            constructor() {
                this.setupEventListeners();
            }

            setupEventListeners() {
                // è®¾ç½®èŒƒå›´æ»‘å—çš„äº‹ä»¶ç›‘å¬
                document.getElementById('steps').addEventListener('input', 
                    e => document.getElementById('steps-value').textContent = e.target.value);
                document.getElementById('cfg').addEventListener('input', 
                    e => document.getElementById('cfg-value').textContent = e.target.value);
                
                // è®¾ç½®é¢„è®¾æŒ‰é’®çš„äº‹ä»¶ç›‘å¬
                document.querySelectorAll('[onclick^="applyPreset"]').forEach(button => {
                    button.addEventListener('click', e => {
                        const preset = e.target.getAttribute('onclick').match(/'(.+)'/)[1];
                        this.applyPreset(preset);
                    });
                });
            }

            async generate() {
                if (AppState.isGenerating) {
                    Utils.showToast('å·²æœ‰ç”Ÿæˆä»»åŠ¡æ­£åœ¨è¿›è¡Œä¸­', 'warning');
                    return;
                }

                try {
                    AppState.isGenerating = true;
                    document.getElementById('generate-button').disabled = true;
                    
                    const params = this.collectParams();
                    Utils.validateGenerationParams(params);

                    Utils.showToast('æ­£åœ¨ç”Ÿæˆå›¾åƒ...', 'info');
                    const results = await this.callGenerationAPI(params);
                    
                    this.displayResults(results);
                    this.saveToHistory(results, params);
                    
                    Utils.showToast('ç”Ÿæˆå®Œæˆï¼', 'success');
                } catch (error) {
                    console.error('Generation failed:', error);
                    Utils.showToast(error.message || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                } finally {
                    AppState.isGenerating = false;
                    document.getElementById('generate-button').disabled = false;
                }
            }

            collectParams() {
                return {
                    prompt: Utils.sanitizePrompt(document.getElementById('positive-prompt').value),
                    negative_prompt: Utils.sanitizePrompt(document.getElementById('negative-prompt').value),
                    model: document.getElementById('base-model').value,
                    sampler: document.getElementById('sampler').value,
                    steps: parseInt(document.getElementById('steps').value),
                    cfg_scale: parseFloat(document.getElementById('cfg').value),
                    seed: parseInt(document.getElementById('seed').value) || -1,
                    width: parseInt(document.getElementById('width').value),
                    height: parseInt(document.getElementById('height').value),
                    batch_size: parseInt(document.getElementById('batch-count').value),
                    vae: document.getElementById('vae-model').value
                };
            }

            async callGenerationAPI(params) {
                // å®ç°APIè°ƒç”¨é€»è¾‘ï¼Œä½¿ç”¨APIHandlerç±»å¤„ç†å…·ä½“è¯·æ±‚
                const results = [];
                const total = params.batch_size;
                
                for (let i = 0; i < total; i++) {
                    try {
                        const result = await APIHandler.generateImage(params);
                        results.push(result);
                        
                        // æ›´æ–°è¿›åº¦
                        const progress = ((i + 1) / total * 100).toFixed(0);
                        document.getElementById('loading-text').textContent = 
                            `æ­£åœ¨ç”Ÿæˆ... ${progress}%`;
                    } catch (error) {
                        console.error(`Failed to generate image ${i + 1}:`, error);
                        throw error;
                    }
                }
                
                return results;
            }

            displayResults(results) {
                const container = document.getElementById('results-grid');
                container.innerHTML = '';
                
                results.forEach((url, index) => {
                    const card = document.createElement('div');
                    card.className = 'result-card card';
                    card.innerHTML = `
                        <img src="${url}" alt="ç”Ÿæˆçš„å›¾ç‰‡ ${index + 1}">
                        <div class="result-actions">
                            <button onclick="Utils.downloadImage('${url}')" class="button">
                                <i class="bi bi-download"></i>
                            </button>
                            <button onclick="copyImageUrl('${url}')" class="button">
                                <i class="bi bi-link-45deg"></i>
                            </button>
                            <button onclick="editImage('${url}')" class="button">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(card);
                });

                AppState.lastGeneratedImages = results;
            }

            saveToHistory(results, params) {
                const historyItem = {
                    id: Date.now(),
                    timestamp: Utils.formatDate(new Date()),
                    images: results,
                    params: params
                };
                
                AppState.history.unshift(historyItem);
                if (AppState.history.length > 50) {
                    AppState.history.pop();
                }
                
                AppState.saveHistory();
                this.updateHistoryDisplay();
            }

            updateHistoryDisplay() {
                const container = document.getElementById('history-container');
                container.innerHTML = '';
                
                AppState.history.forEach(item => {
                    const historyCard = document.createElement('div');
                    historyCard.className = 'history-card card';
                    historyCard.innerHTML = `
                        <img src="${item.images[0]}" alt="å†å²è®°å½•ç¼©ç•¥å›¾">
                        <div class="history-info">
                            <small>${item.timestamp}</small>
                            <button onclick="loadHistoryItem(${item.id})" class="button">
                                <i class="bi bi-arrow-counterclockwise"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(historyCard);
                });
            }

            applyPreset(presetName) {
                const preset = window.APP_CONFIG.presets[presetName];
                if (!preset) return;

                Object.entries(preset).forEach(([key, value]) => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = value;
                        // è§¦å‘changeäº‹ä»¶ä»¥æ›´æ–°æ˜¾ç¤ºå€¼
                        element.dispatchEvent(new Event('input'));
                    }
                });

                Utils.showToast(`å·²åº”ç”¨${presetName}é¢„è®¾`, 'success');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            AppState.init();
            window.generator = new ImageGenerator();
            
            // æ ‡ç­¾é¡µåˆ‡æ¢é€»è¾‘
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    document.querySelectorAll('.tab-button').forEach(btn => 
                        btn.classList.toggle('active', btn === button));
                    
                    // æ›´æ–°é¢æ¿æ˜¾ç¤º
                    document.querySelectorAll('.tab-panel').forEach(panel => 
                        panel.classList.toggle('hidden', panel.id !== `${tabId}-panel`));
                    
                    AppState.currentTab = tabId;
                });
            });

            // ä¸»é¢˜åˆ‡æ¢
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
            if (prefersDark.matches) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
            
            prefersDark.addEventListener('change', e => {
                document.documentElement.setAttribute('data-theme', 
                    e.matches ? 'dark' : 'light');
            });
        });

        // å…¨å±€å‡½æ•°
        window.startGeneration = () => window.generator.generate();
        window.applyPreset = (preset) => window.generator.applyPreset(preset);
        window.loadHistoryItem = (id) => {
            const item = AppState.history.find(h => h.id === id);
            if (item) {
                Object.entries(item.params).forEach(([key, value]) => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = value;
                        element.dispatchEvent(new Event('input'));
                    }
                });
                Utils.showToast('å·²åŠ è½½å†å²å‚æ•°', 'success');
            }
        };
        window.randomizeSeed = () => {
            document.getElementById('seed').value = Utils.randomInt(-1, 2147483647);
        };
        window.copyImageUrl = async (url) => {
            await Utils.copyToClipboard(url);
        };
        window.editImage = (url) => {
            // åˆ‡æ¢åˆ°å›¾ç”Ÿå›¾æ¨¡å¼å¹¶åŠ è½½å›¾ç‰‡
            document.querySelector('[data-tab="img2img"]').click();
            // TODO: å®ç°å›¾ç‰‡åŠ è½½é€»è¾‘
        };
    </script>

    <!-- æ€§èƒ½ç›‘æ§ -->
    <script src="https://cdn.jsdelivr.net/npm/web-vitals@3"></script>
    <script>
        // ç›‘æ§Web Vitalsæ€§èƒ½æŒ‡æ ‡
        webVitals.onCLS(console.log);
        webVitals.onFID(console.log);
        webVitals.onLCP(console.log);
        webVitals.onTTFB(console.log);
        webVitals.onFCP(console.log);
    </script>
</body>
</html>
